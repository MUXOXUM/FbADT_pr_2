# ООО "СистемаКотроля"
## Микросервисная структура по управлению задачами по работе со строительными объектами

План работы над проектом
Вам необходимо собрать рабочий бэкенд с тремя компонентами:
• Шлюз
• Сервис пользователей
• Сервис заказов
Обеспечить регистрацию и вход, работу с профилем, полный жизненный
цикл заказа, единый вход через шлюз, логирование.

Объём работ
• Реализовать маршруты и проверку прав в сервисах
• Включить логи и трассировки во всех компонентах
• Подготовить окружения для трёх профилей swagger
• Описать интерфейсы в OpenAPI и приложить файл спецификации
swagger в директории docs

Требования к функционалу (REST-запросы)
Шлюз
• Прокидывает пути users и orders на соответствующие сервисы
• Проверяет JWT на защищённых путях
• Ограничивает частоту запросов и сглаживает всплески
• Корректно обрабатывает CORS и заголовок X Request ID с
прокидыванием вглубь

Сервис пользователей
• Регистрация нового пользователя с валидацией входных полей
• Вход и выдача JWT
• Получение текущего профиля и обновление профиля
• Список пользователей для роли администратор с пагинацией и
фильтрами

Сервис заказов
• Создание заказа с проверкой входных данных и существования
пользователя
• Получение заказа по идентификатору
• Список заказов текущего пользователя с пагинацией и сортировками
• Обновление статуса и отмена заказа
• Проверка прав на уровне сервиса для каждой операции

Доменные события
• Публикация события создан заказ
• Публикация события обновлён статус
• Заготовка для подключения брокера сообщений в следующих
итерациях

Формат интерфейсов
• Ответы в JSON с полями: success и data error
• Единая ошибка с полями: code и message
• Версионирование путей через префикс v1
• Авторизация через заголовок Authorization со схемой Bearer и токеном
JWT
• На свободном доступе только регистрация и вход

Требования к данным
Пользователь 
• Идентификатор UUID
• Электронная почта
• Хэш пароля
• Имя
• Роли массив строк
• Дата создания
• Дата обновления

Заказ
• Идентификатор UUID
• Идентификатор пользователя
UUID
• Состав позиции товар
количество
• Статус создан в работе
выполнен отменён
• Итоговая сумма
• Дата создания
• Дата обновления

Подсказки по реализации
– Для JWT удобно взять библиотеку jsonwebtoken
– Для логов подойдёт pino
– Для валидации данных удобны zod или joi
– Для ограничения частоты запросов подойдёт express rate limit

## Запуск проекта

### Использование Docker Compose

```bash
docker-compose up --build
```

Сервисы будут доступны:
- API Gateway: http://localhost:8000
- Users Service: http://service_users:8000 (внутри Docker сети)
- Orders Service: http://service_orders:8000 (внутри Docker сети)

### Переменные окружения

Создайте файл `.env` в корне проекта с необходимыми переменными окружения. Пример содержимого находится в `docs/ENV.md`.

**Важно:** Обязательно установите свой уникальный `JWT_SECRET` перед запуском в production!

Для production рекомендуется:
- `NODE_ENV=production`
- `PINO_PRETTY=false`
- `LOG_LEVEL=info` или `warn`
- Установите собственный сильный `JWT_SECRET`

### Тестовый администратор

По умолчанию создается тестовый администратор:
- Email: `admin@example.com`
- Password: `admin123`

### Документация API

OpenAPI спецификация находится в `docs/swagger.yaml`
Примеры использования API находятся в `docs/API_EXAMPLES.md`

## Тестирование

### Запуск тестов

Для запуска unit тестов:

```bash
# User Service
cd service_users
npm install
npm test

# Order Service
cd service_orders
npm install
npm test
```

Подробная документация по тестированию находится в `docs/TESTING.md`

### Реализованные тесты

✅ **User Service:**
- Успешная регистрация с валидными полями - ожидаем статус успех и созданный идентификатор
- Повторная регистрация с той же почтой - ожидаем контролируемую ошибку
- Вход с правильными данными - ожидаем выдачу токена
- Доступ к защищённому пути без токена - ожидаем отказ

✅ **Order Service:**
- Создание заказа для авторизованного пользователя - ожидаем успех и статус создан
- Получение своего заказа - ожидаем успех
- Список своих заказов с пагинацией - ожидаем корректные поля и навигацию по страницам
- Попытка обновить чужой заказ - ожидаем отказ
- Отмена собственного заказа - ожидаем статус отменён и отсутствие побочных эффектов

# Переменные окружения (.env)

Создайте файл `.env` в корне проекта (он уже добавлен в `.gitignore`, поэтому не попадёт в репозиторий) со значениями по вашему окружению.

Пример содержимого:
```
NODE_ENV=development
LOG_LEVEL=info
PINO_PRETTY=false

# Безопасный ключ для подписи JWT (обязательно заменить на уникальный)
JWT_SECRET=change-me-please

# Базовые URL сервисов
USERS_SERVICE_URL=http://service_users:8000
ORDERS_SERVICE_URL=http://service_orders:8000

# Разрешённый origin для CORS (для разработки можно оставить *)
CORS_ORIGIN=*
```

Для production:
- `NODE_ENV=production`
- `PINO_PRETTY=false`
- `LOG_LEVEL=info` или `warn`
- Установите собственный сильный `JWT_SECRET`
